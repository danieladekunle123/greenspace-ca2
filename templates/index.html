<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GreenSpace: Dublin Footpaths & Parks Explorer</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <meta name="theme-color" content="#198754" />
    <!-- PWA manifest -->
    <link rel="manifest" href="/static/manifest.json" />
    <!-- Icons for browser / mobile -->
    <link rel="icon" href="/static/img/icon-192.png" />
    <link rel="apple-touch-icon" href="/static/img/icon-192.png" />

    <style>
      body {
        min-height: 100vh;
        background: url("/static/img/bg-city.jpg") center/cover fixed no-repeat;
      }

      .glass {
        background: rgba(255, 255, 255, 0.86);
        backdrop-filter: blur(6px);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      #map {
        height: 70vh;
        border-radius: 12px;
      }

      @media (min-width: 768px) {
        #map {
          height: 78vh;
        }
      }

      .result-item {
        cursor: pointer;
      }
    </style>
  </head>

  <body class="py-4">
    <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Report accessibility issue</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="issueRouteId" />
            <div class="mb-2">
              <label class="form-label">Issue type</label>
              <select id="issueType" class="form-select">
                <option value="broken_pavement">Broken pavement</option>
                <option value="blocked_ramp">Blocked ramp</option>
                <option value="steep_slope">Steep slope</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Details (optional)</label>
              <textarea
                id="issueDesc"
                class="form-control"
                rows="3"
                placeholder="Describe the issue…"
              ></textarea>
            </div>
            <p class="small text-muted mb-0">
              We’ll use your current marker location as the issue location.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" id="issueSubmit" class="btn btn-danger">
              Submit issue
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="p-3 p-md-4 glass">
        <h1 class="h3 mb-3 text-center">
          GreenSpace: Dublin Footpaths & Parks Explorer
        </h1>

        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <button id="locBtn" class="btn btn-primary">Use my location</button>
          </div>
          <div class="col-auto">
            <label for="radius" class="form-label mb-0">Radius (m)</label>
          </div>
          <div class="col-auto">
            <input
              id="radius"
              class="form-control"
              type="number"
              value="2000"
              min="100"
              step="100"
              style="width: 120px"
            />
          </div>
          <div class="col-auto">
            <button id="searchBtn" class="btn btn-success">Find Parks</button>
          </div>
          <div class="col-auto">
            <button id="nearestBtn" class="btn btn-warning text-dark">
              Nearest Playground
            </button>
          </div>
          <div class="col-auto">
            <button id="routesBtn" class="btn btn-outline-primary">
              Show Footpaths in Radius
            </button>
          </div>
          <div class="col-auto">
            <button id="clearBtn" class="btn btn-outline-danger">
              Clear Map
            </button>
          </div>

          <div class="col-12 col-md-auto mt-2 mt-md-0 ms-md-auto">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="accessibleToggle"
              />
              <label class="form-check-label" for="accessibleToggle">
                Accessible routes only
              </label>
            </div>
          </div>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-12 col-md-6">
            <input
              id="searchParks"
              class="form-control"
              placeholder="Search parks by name…"
            />
            <div id="parksResults" class="list-group mt-1"></div>
          </div>
          <div class="col-12 col-md-6">
            <input
              id="searchPlaygrounds"
              class="form-control"
              placeholder="Search playgrounds by name…"
            />
            <div id="pgResults" class="list-group mt-1"></div>
          </div>
        </div>

        <div
          id="status"
          class="mt-2 small text-muted text-center"
          aria-live="polite"
        ></div>

        <div id="map" class="mt-3"></div>
      </div>

      <div class="row mt-3 justify-content-center">
        <div class="col-12 col-lg-8 col-xl-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3 text-center">
                Manage Personal Playgrounds
              </h5>

              <div class="row g-2 align-items-end justify-content-center">
                <div class="col-12 col-md-4">
                  <label class="form-label">Name</label>
                  <input
                    id="pgName"
                    class="form-control"
                    placeholder="Playground name"
                  />
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">Lat</label>
                  <input id="pgLat" class="form-control" placeholder="53.35" />
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">Lng</label>
                  <input id="pgLng" class="form-control" placeholder="-6.26" />
                </div>

                <div class="col-auto">
                  <button id="pgCreate" class="btn btn-outline-success btn-sm">
                    Create
                  </button>
                </div>

                <div class="col-5 col-md-3 col-lg-2">
                  <label class="form-label">ID</label>
                  <input id="pgId" class="form-control" placeholder="id" />
                </div>

                <div class="col-auto">
                  <button id="pgUpdate" class="btn btn-outline-primary btn-sm">
                    Update Name
                  </button>
                </div>
                <div class="col-auto">
                  <button id="pgDelete" class="btn btn-outline-danger btn-sm">
                    Delete
                  </button>
                </div>
              </div>

              <div
                id="pgCrudStatus"
                class="small text-muted mt-2 text-center"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const map = L.map("map").setView([53.3498, -6.2603], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let userMarker, parksLayer, routesLayer, playgroundMarker, highlightLayer;
      let currentAbort;
      let lastRoutesParkId = null;
      const statusDiv = document.getElementById("status");

      let issueModal;
      document.addEventListener("DOMContentLoaded", () => {
        const modalEl = document.getElementById("issueModal");
        if (modalEl) issueModal = new bootstrap.Modal(modalEl);
      });

      function writeLatLngToInputs(lat, lng) {
        const latInput = document.getElementById("pgLat");
        const lngInput = document.getElementById("pgLng");
        if (latInput) latInput.value = lat.toFixed(6);
        if (lngInput) lngInput.value = lng.toFixed(6);
      }

      function setUserMarker(lat, lng) {
        if (userMarker) map.removeLayer(userMarker);

        userMarker = L.marker([lat, lng], { draggable: true })
          .addTo(map)
          .bindPopup("You are here");

        map.setView([lat, lng], 13);

        writeLatLngToInputs(lat, lng);

        userMarker.on("dragend", (e) => {
          const p = e.target.getLatLng();
          writeLatLngToInputs(p.lat, p.lng);
          statusDiv.textContent = "Location updated from marker drag.";
        });
      }

      function removeLayerSafe(layer) {
        if (layer && map.hasLayer(layer)) map.removeLayer(layer);
      }

      function clearParks() {
        removeLayerSafe(parksLayer);
        parksLayer = null;
      }

      function clearRoutes() {
        removeLayerSafe(routesLayer);
        routesLayer = null;
        lastRoutesParkId = null;
      }

      function clearPlayground() {
        removeLayerSafe(playgroundMarker);
        playgroundMarker = null;
      }

      function clearHighlight() {
        if (typeof highlightLayer !== "undefined") {
          removeLayerSafe(highlightLayer);
          highlightLayer = null;
        }
      }

      function clearMap() {
        clearParks();
        clearRoutes();
        clearPlayground();
        clearHighlight();
        statusDiv.textContent = "Cleared.";
      }

      function setLoading(btn, isLoading, message) {
        if (btn) {
          btn.disabled = isLoading;
          btn.dataset._origText ??= btn.textContent;
          btn.textContent = isLoading ? "Loading..." : btn.dataset._origText;
        }
        statusDiv.textContent = isLoading ? message : "";
      }

      async function fetchJSON(url, btn, message) {
        try {
          if (currentAbort) currentAbort.abort();
          currentAbort = new AbortController();
          setLoading(btn, true, message);
          const res = await fetch(url, { signal: currentAbort.signal });
          if (!res.ok) throw new Error(await res.text());
          return await res.json();
        } catch (e) {
          console.error(e);
          alert("Request failed: " + (e.message || e));
          return { features: [] };
        } finally {
          setLoading(btn, false, "");
        }
      }

      async function showParks(lat, lng, radius, btn) {
        clearParks();
        clearRoutes();
        clearPlayground();

        if (parksLayer) {
          map.removeLayer(parksLayer);
        }
        const data = await fetchJSON(
          `/api/parks/within?lat=${lat}&lng=${lng}&radius_m=${radius}`,
          btn,
          "Loading parks…"
        );
        if (!data.features.length) {
          alert("No parks found in this radius.");
          return;
        }

        parksLayer = L.geoJSON(
          data.features.map((f) => ({
            type: "Feature",
            properties: { id: f.id, name: f.name, category: f.category },
            geometry: JSON.parse(f.geom),
          })),
          {
            onEachFeature: (feat, layer) => {
              layer.bindPopup(
                `<b>${feat.properties.name || "Park"}</b><br>${
                  feat.properties.category || ""
                }
               <br><button class="btn btn-sm btn-link" onclick="showRoutes(${
                 feat.properties.id
               })">Show footpaths</button>`
              );
            },
            style: { weight: 1 },
          }
        ).addTo(map);

        map.fitBounds(parksLayer.getBounds(), { padding: [20, 20] });
        statusDiv.textContent = `${data.features.length} park(s) found within ${radius} m.`;
      }

      async function showRoutes(parkId) {
        if (routesLayer && lastRoutesParkId === parkId) {
          clearRoutes();
          statusDiv.textContent = "Footpaths hidden.";
          return;
        }

        clearRoutes();
        const btn = document.getElementById("routesBtn");
        const data = await fetchJSON(
          `/api/routes/intersecting_park?park_id=${parkId}`,
          btn,
          "Loading footpaths…"
        );
        if (!data.features.length) {
          alert("No footpaths intersect this park.");
          return;
        }

        routesLayer = L.geoJSON(
          data.features.map((f) => ({
            type: "Feature",
            properties: { id: f.id, name: f.name },
            geometry: JSON.parse(f.geom),
          })),
          { weight: 3 }
        ).addTo(map);

        routesLayer.bringToFront();
        map.fitBounds(routesLayer.getBounds(), { padding: [20, 20] });
        statusDiv.textContent = `${data.features.length} footpath(s) displayed.`;
        lastRoutesParkId = parkId;
      }

      async function showRoutesWithin(lat, lng, radius, btn, accessibleOnly) {
        clearRoutes();

        if (routesLayer) {
          map.removeLayer(routesLayer);
        }

        const qs = `lat=${lat}&lng=${lng}&radius_m=${radius}&accessible_only=${
          accessibleOnly ? "true" : "false"
        }`;

        const data = await fetchJSON(
          `/api/access/routes/within?${qs}`,
          btn,
          accessibleOnly
            ? "Searching accessible footpaths…"
            : "Searching nearby footpaths…"
        );

        if (!data.features.length) {
          alert(
            accessibleOnly
              ? "No accessible footpaths found in this radius."
              : "No footpaths found in this radius."
          );
          return;
        }

        routesLayer = L.geoJSON(
          data.features.map((f) => ({
            type: "Feature",
            properties: {
              id: f.id,
              name: f.name,
              surface: f.surface,
              smoothness: f.smoothness,
              is_accessible: f.is_accessible,
            },
            geometry: JSON.parse(f.geom),
          })),
          {
            // basic styling: accessible = thicker/greenish, others = grey
            style: (feat) => {
              const acc = feat.properties.is_accessible;
              return {
                weight: acc ? 4 : 2,
                opacity: acc ? 1 : 0.6,
              };
            },
            onEachFeature: (feat, layer) => {
              const accLabel =
                feat.properties.is_accessible === true
                  ? "Accessible ✅"
                  : "Accessibility unknown ❓";

              const surf = feat.properties.surface || "n/a";
              const smooth = feat.properties.smoothness || "n/a";

              layer.bindPopup(
                `<b>${feat.properties.name || "Footpath"}</b><br>
                ${accLabel}<br>
                Surface: ${surf}<br>
                Smoothness: ${smooth}<br>
                <button class="btn btn-sm btn-outline-danger mt-2"
                  onclick="openIssueForm(${feat.properties.id})">
                  Report accessibility issue
                </button>`
              );
            },
          }
        ).addTo(map);

        routesLayer.bringToFront();
        map.fitBounds(routesLayer.getBounds(), { padding: [20, 20] });
        statusDiv.textContent = `${
          data.features.length
        } footpath(s) found in ${radius} m.${
          accessibleOnly ? " (accessible only)" : ""
        }`;
      }

      async function showNearestPlayground(lat, lng, btn) {
        clearPlayground();

        if (playgroundMarker) {
          map.removeLayer(playgroundMarker);
        }
        const data = await fetchJSON(
          `/api/playgrounds/nearest?lat=${lat}&lng=${lng}&limit=1`,
          btn,
          "Finding nearest playground…"
        );
        if (!data.features.length) {
          alert("No playgrounds in dataset");
          return;
        }
        const f = data.features[0];
        const g = JSON.parse(f.geom);
        const [plng, plat] = g.coordinates;
        const name = f.name || "Playground";
        playgroundMarker = L.marker([plat, plng])
          .addTo(map)
          .bindPopup(`<b>${name}</b><br>Nearest playground`)
          .openPopup();
        map.setView([plat, plng], 15);
        statusDiv.textContent = `Nearest playground: ${name}`;
      }

      function debounce(fn, ms = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }
      function clearHighlight() {
        if (highlightLayer) {
          map.removeLayer(highlightLayer);
          highlightLayer = null;
        }
      }

      async function searchAndList(url, listElem, label) {
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        listElem.innerHTML = "";
        clearHighlight();
        if (!data.features.length) {
          listElem.innerHTML = `<div class="list-group-item small text-muted">No ${label} found.</div>`;
          return;
        }
        data.features.forEach((f) => {
          const li = document.createElement("button");
          li.className = "list-group-item list-group-item-action result-item";
          li.textContent =
            f.name || (label === "parks" ? "Park" : "Playground");
          li.onclick = () => {
            clearHighlight();
            const gj = {
              type: "Feature",
              properties: { name: f.name || "" },
              geometry: JSON.parse(f.geom),
            };
            highlightLayer = L.geoJSON(gj, { style: { weight: 4 } }).addTo(map);
            const b = highlightLayer.getBounds
              ? highlightLayer.getBounds()
              : null;
            if (b && b.isValid()) map.fitBounds(b, { padding: [20, 20] });
            else if (gj.geometry.type === "Point")
              map.setView(
                [gj.geometry.coordinates[1], gj.geometry.coordinates[0]],
                16
              );
          };
          listElem.appendChild(li);
        });
      }

      const locBtn = document.getElementById("locBtn");
      const parksBtn = document.getElementById("searchBtn");
      const nearBtn = document.getElementById("nearestBtn");
      const routesBtn = document.getElementById("routesBtn");
      const clearBtn = document.getElementById("clearBtn");
      const accessibleToggle = document.getElementById("accessibleToggle");

      document.getElementById("pgCreate").onclick = pgCreate;
      document.getElementById("pgUpdate").onclick = pgUpdate;
      document.getElementById("pgDelete").onclick = pgDelete;

      clearBtn.onclick = clearMap;

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") clearMap();
      });

      locBtn.onclick = () => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            setUserMarker(latitude, longitude);
            statusDiv.textContent = "Location set.";
          },
          (err) => {
            console.warn(err);
            alert(
              "Location permission denied. You can still click on the map to set a location."
            );
          }
        );
      };

      map.on("click", (e) => {
        setUserMarker(e.latlng.lat, e.latlng.lng);
        clearHighlight();
        statusDiv.textContent = "Custom location set.";
      });

      parksBtn.onclick = () => {
        if (!userMarker) {
          alert("Set your location first (Use my location or click the map).");
          return;
        }
        const radius = +document.getElementById("radius").value || 2000;
        const { lat, lng } = userMarker.getLatLng();
        showParks(lat, lng, radius, parksBtn);
      };

      nearBtn.onclick = () => {
        if (!userMarker) {
          alert("Set your location first.");
          return;
        }
        const { lat, lng } = userMarker.getLatLng();
        showNearestPlayground(lat, lng, nearBtn);
      };

      routesBtn.onclick = () => {
        if (!userMarker) {
          alert("Set your location first.");
          return;
        }
        const radius = +document.getElementById("radius").value || 1000;
        const { lat, lng } = userMarker.getLatLng();
        const accessibleOnly = accessibleToggle && accessibleToggle.checked;
        showRoutesWithin(lat, lng, radius, routesBtn, accessibleOnly);
      };

      const parksInput = document.getElementById("searchParks");
      const parksResults = document.getElementById("parksResults");
      const pgInput = document.getElementById("searchPlaygrounds");
      const pgResults = document.getElementById("pgResults");

      parksInput.addEventListener(
        "input",
        debounce(() => {
          const q = parksInput.value.trim();
          if (q.length < 2) {
            parksResults.innerHTML = "";
            return;
          }
          searchAndList(
            `/api/parks/search?q=${encodeURIComponent(q)}`,
            parksResults,
            "parks"
          );
        }, 300)
      );

      pgInput.addEventListener(
        "input",
        debounce(() => {
          const q = pgInput.value.trim();
          if (q.length < 2) {
            pgResults.innerHTML = "";
            return;
          }
          searchAndList(
            `/api/playgrounds/search?q=${encodeURIComponent(q)}`,
            pgResults,
            "playgrounds"
          );
        }, 300)
      );

      const pgCrudStatus = document.getElementById("pgCrudStatus");

      async function pgCreate() {
        const name =
          document.getElementById("pgName").value.trim() || "Playground";
        const lat = parseFloat(document.getElementById("pgLat").value);
        const lng = parseFloat(document.getElementById("pgLng").value);
        if (Number.isNaN(lat) || Number.isNaN(lng)) {
          pgCrudStatus.textContent = "Enter valid lat/lng.";
          return;
        }
        pgCrudStatus.textContent = "Creating…";
        const res = await fetch("/api/playgrounds", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, lat, lng }),
        });
        const data = await res.json();
        if (!res.ok) {
          pgCrudStatus.textContent = data.error || "Create failed";
          return;
        }
        pgCrudStatus.textContent = `Created id=${data.created.id} (${data.created.name})`;
      }

      async function pgUpdate() {
        const id = parseInt(document.getElementById("pgId").value, 10);
        const name = document.getElementById("pgName").value.trim();
        if (!id || !name) {
          pgCrudStatus.textContent = "Enter id and new name.";
          return;
        }
        pgCrudStatus.textContent = "Updating…";
        const res = await fetch(`/api/playgrounds/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name }),
        });
        const data = await res.json();
        if (!res.ok) {
          pgCrudStatus.textContent = data.error || "Update failed";
          return;
        }
        pgCrudStatus.textContent = `Updated id=${data.updated.id} → ${data.updated.name}`;
      }

      async function pgDelete() {
        const id = parseInt(document.getElementById("pgId").value, 10);
        if (!id) {
          pgCrudStatus.textContent = "Enter id to delete.";
          return;
        }
        pgCrudStatus.textContent = "Deleting…";
        const res = await fetch(`/api/playgrounds/${id}/delete`, {
          method: "DELETE",
        });
        const data = await res.json();
        if (!res.ok) {
          pgCrudStatus.textContent = data.error || "Delete failed";
          return;
        }
        pgCrudStatus.textContent = `Deleted id=${data.deleted}`;
      }

      window.openIssueForm = function (routeId) {
        if (!userMarker) {
          alert("Set your location first so we know where the issue is.");
          return;
        }
        document.getElementById("issueRouteId").value = routeId;
        document.getElementById("issueType").value = "broken_pavement";
        document.getElementById("issueDesc").value = "";
        issueModal.show();
      };

      document.getElementById("issueSubmit").onclick = async () => {
        if (!userMarker) {
          alert("Set your location first.");
          return;
        }
        const routeId = parseInt(
          document.getElementById("issueRouteId").value,
          10
        );
        const issueType = document.getElementById("issueType").value;
        const description = document.getElementById("issueDesc").value.trim();

        const { lat, lng } = userMarker.getLatLng();

        try {
          const res = await fetch("/api/access/issues", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              route_id: routeId,
              issue_type: issueType,
              description,
              lat,
              lng,
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to save issue");
          statusDiv.textContent = "Thanks – issue reported.";
          issueModal.hide();
        } catch (e) {
          alert("Could not save issue: " + e.message);
        }
      };
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/static/service-worker.js")
            .catch((err) =>
              console.log("Service worker registration failed", err)
            );
        });
      }
    </script>
  </body>
</html>
